from src.agents.swarm.Recon import make_recon_agent
from src.agents.swarm.InitAccess import make_initaccess_agent
from src.agents.swarm.Planner import make_planner_agent
from src.agents.swarm.Summary import make_summary_agent
from src.utils.swarm.swarm import create_swarm
from src.utils.memory import get_checkpointer, get_store
import asyncio
import logging

logger = logging.getLogger(__name__)

checkpointer = get_checkpointer()
store = get_store() 

async def create_agents():
    """Dynamically create agents after user selects model"""
    recon = await make_recon_agent()
    initaccess = await make_initaccess_agent()
    planner = await make_planner_agent()
    summary = await make_summary_agent()
    return [recon, initaccess, planner, summary]

async def create_dynamic_swarm():
    """Create swarm dynamically - Called after model selection"""
    logger.info("Creating dynamic swarm with InMemory persistence")
    
    agents = await create_agents()
    workflow = create_swarm(
        agents=agents,
        default_active_agent="Planner",
    )
    
    compiled_workflow = workflow.compile(
        checkpointer=checkpointer,
        store=store,
    )
    
    logger.info("Swarm compiled with InMemory checkpointer and store, recursion_limit=30")
    return compiled_workflow
